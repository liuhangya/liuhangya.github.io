<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <meta name="description" content="个人技术博客">
  
  <title>
    livedata |
    
    fanda&#39;s blog
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="fanda's blog" type="application/atom+xml">
</head>

<body>
  <main class="content">
    <section class="outer">
  <article
  id="post-livedata"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
      

<h1 class="article-title" itemprop="name">
  livedata
</h1>



    </header>
     
    <div class="article-meta">
      <a href="/2022/06/06/livedata/" class="article-date">
  <time datetime="2022-06-06T06:23:54.000Z" itemprop="datePublished">2022-06-06</time>
</a> 
    </div>
       

    <div class="article-entry" itemprop="articleBody">
         <p>LiveData (可观察的数据存储器类)，使用篇…</p>
<span id="more"></span>

<h2 id="LiveData-可观察的数据存储器类-，使用篇"><a href="#LiveData-可观察的数据存储器类-，使用篇" class="headerlink" title="LiveData (可观察的数据存储器类)，使用篇"></a><strong>LiveData (可观察的数据存储器类)，使用篇</strong></h2><!-- 本地图片引用 -->
<!-- <img src="/2022/06/06/livedata/juanjuan01.jpg" class=""> -->

<p><img src="/2022/06/06/livedata/juanjuan01.jpg"></p>
<h4 id="作用：不是普通的观察类，具有生命周期感知能力，能够在-Activity、Fragment、Service-中正确的处理生命周期。"><a href="#作用：不是普通的观察类，具有生命周期感知能力，能够在-Activity、Fragment、Service-中正确的处理生命周期。" class="headerlink" title="作用：不是普通的观察类，具有生命周期感知能力，能够在 Activity、Fragment、Service 中正确的处理生命周期。"></a>作用：不是普通的观察类，具有生命周期感知能力，能够在 <code>Activity、Fragment、Service</code> 中正确的处理生命周期。</h4><h4 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h4><h5 id="1-LiveData-是一个数据持有者，是数据源的包装类。"><a href="#1-LiveData-是一个数据持有者，是数据源的包装类。" class="headerlink" title="1. LiveData 是一个数据持有者，是数据源的包装类。"></a>1. <code>LiveData</code> 是一个数据持有者，是数据源的包装类。</h5><h5 id=""><a href="#" class="headerlink" title=""></a></h5><h5 id="2-源数据使用-LiveData-进行包装之后，可以被观察，当数据有更新时，观察者可感知。"><a href="#2-源数据使用-LiveData-进行包装之后，可以被观察，当数据有更新时，观察者可感知。" class="headerlink" title="2. 源数据使用 LiveData 进行包装之后，可以被观察，当数据有更新时，观察者可感知。"></a>2. 源数据使用 <code>LiveData</code> 进行包装之后，可以被观察，当数据有更新时，观察者可感知。</h5><h5 id="-1"><a href="#-1" class="headerlink" title=""></a></h5><h5 id="3-观察者感知或被通知到的时机是跟生命周期相关的，只发生在-Activity-Fragment-活跃生命周期状态，如果一个观察者处于-Paused-或-Destroyed-状态，它将不会收到通知。"><a href="#3-观察者感知或被通知到的时机是跟生命周期相关的，只发生在-Activity-Fragment-活跃生命周期状态，如果一个观察者处于-Paused-或-Destroyed-状态，它将不会收到通知。" class="headerlink" title="3. 观察者感知或被通知到的时机是跟生命周期相关的，只发生在 Activity/Fragment 活跃生命周期状态，如果一个观察者处于 Paused 或 Destroyed 状态，它将不会收到通知。"></a>3. 观察者感知或被通知到的时机是跟生命周期相关的，只发生在 <code>Activity/Fragment</code> 活跃生命周期状态，如果一个观察者处于 <code>Paused</code> 或 <code>Destroyed</code> 状态，它将不会收到通知。</h5><h4 id="优势："><a href="#优势：" class="headerlink" title="优势："></a>优势：</h4><h5 id="1-不会发生内存泄漏且无须手动解除观察，LiveData-会在相应生命周期自动移除。"><a href="#1-不会发生内存泄漏且无须手动解除观察，LiveData-会在相应生命周期自动移除。" class="headerlink" title="1. 不会发生内存泄漏且无须手动解除观察，LiveData 会在相应生命周期自动移除。"></a>1. 不会发生内存泄漏且无须手动解除观察，<code>LiveData</code> 会在相应生命周期自动移除。</h5><h5 id="-2"><a href="#-2" class="headerlink" title=""></a></h5><h5 id="2-不会因-Activity-停止而导致崩溃，当生命周期处于非活跃状态，不会接收任何-LiveData-事件。"><a href="#2-不会因-Activity-停止而导致崩溃，当生命周期处于非活跃状态，不会接收任何-LiveData-事件。" class="headerlink" title="2. 不会因 Activity 停止而导致崩溃，当生命周期处于非活跃状态，不会接收任何 LiveData 事件。"></a>2. 不会因 <code>Activity</code> 停止而导致崩溃，当生命周期处于非活跃状态，不会接收任何 <code>LiveData</code> 事件。</h5><h5 id="-3"><a href="#-3" class="headerlink" title=""></a></h5><h5 id="3-数据始终保持最新状态且避免重复刷新界面，数据更新时若-Activity-为非活跃状态，那么会在变为活跃时接收最新数据。例如，在后台的-Activity-会在返回前台时立即接收最新的数据，而不是在每次数据变化时刷新界面。"><a href="#3-数据始终保持最新状态且避免重复刷新界面，数据更新时若-Activity-为非活跃状态，那么会在变为活跃时接收最新数据。例如，在后台的-Activity-会在返回前台时立即接收最新的数据，而不是在每次数据变化时刷新界面。" class="headerlink" title="3. 数据始终保持最新状态且避免重复刷新界面，数据更新时若 Activity 为非活跃状态，那么会在变为活跃时接收最新数据。例如，在后台的 Activity 会在返回前台时立即接收最新的数据，而不是在每次数据变化时刷新界面。"></a>3. 数据始终保持最新状态且避免重复刷新界面，数据更新时若 <code>Activity</code> 为非活跃状态，那么会在变为活跃时接收最新数据。例如，在后台的 <code>Activity</code> 会在返回前台时立即接收最新的数据，而不是在每次数据变化时刷新界面。</h5><h3 id="LiveData-的基础使用"><a href="#LiveData-的基础使用" class="headerlink" title="LiveData 的基础使用"></a>LiveData 的基础使用</h3><h4 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h4><h5 id="1-创建-LiveData-实例，通过泛型指定源数据类型。"><a href="#1-创建-LiveData-实例，通过泛型指定源数据类型。" class="headerlink" title="1. 创建 LiveData 实例，通过泛型指定源数据类型。"></a>1. 创建 <code>LiveData</code> 实例，通过泛型指定源数据类型。</h5><h5 id="-4"><a href="#-4" class="headerlink" title=""></a></h5><h5 id="2-创建-Observer-实例，实现-onChanged-方法，用于接收源数据变化并刷新-UI。"><a href="#2-创建-Observer-实例，实现-onChanged-方法，用于接收源数据变化并刷新-UI。" class="headerlink" title="2. 创建 Observer 实例，实现 onChanged() 方法，用于接收源数据变化并刷新 UI。"></a>2. 创建 <code>Observer</code> 实例，实现 <code>onChanged()</code> 方法，用于接收源数据变化并刷新 UI。</h5><h5 id="-5"><a href="#-5" class="headerlink" title=""></a></h5><h5 id="3-LiveData-实例使用-observe-方法添加观察者，并传入-LifecycleOwner，就是-Activity-本身。"><a href="#3-LiveData-实例使用-observe-方法添加观察者，并传入-LifecycleOwner，就是-Activity-本身。" class="headerlink" title="3. LiveData 实例使用 observe() 方法添加观察者，并传入 LifecycleOwner，就是 Activity 本身。"></a>3. <code>LiveData</code> 实例使用 <code>observe()</code> 方法添加观察者，并传入 <code>LifecycleOwner</code>，就是 <code>Activity</code> 本身。</h5><h5 id="-6"><a href="#-6" class="headerlink" title=""></a></h5><h5 id="4-LiveData-实例使用-setValue-postValue-更新源数据-（工作线程要使用-postValue-）"><a href="#4-LiveData-实例使用-setValue-postValue-更新源数据-（工作线程要使用-postValue-）" class="headerlink" title="4. LiveData 实例使用 setValue()/postValue() 更新源数据 （工作线程要使用 postValue()）"></a>4. <code>LiveData</code> 实例使用 <code>setValue()/postValue()</code> 更新源数据 （工作线程要使用 <code>postValue()</code>）</h5><h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public class LiveDataTestActivity extends AppCompatActivity&#123;</span><br><span class="line"></span><br><span class="line">   private MutableLiveData&lt;String&gt; mLiveData;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">   protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">       super.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_lifecycle_test);</span><br><span class="line"></span><br><span class="line">       //liveData基本使用</span><br><span class="line">       mLiveData = new MutableLiveData&lt;&gt;();</span><br><span class="line">       mLiveData.observe(this, new Observer&lt;String&gt;() &#123;</span><br><span class="line">           @Override</span><br><span class="line">           public void onChanged(String s) &#123;</span><br><span class="line">               Log.i(TAG, &quot;onChanged: &quot;+s);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       Log.i(TAG, &quot;onCreate: &quot;);</span><br><span class="line">       mLiveData.setValue(&quot;onCreate&quot;);//activity是非活跃状态，不会回调onChanged。变为活跃时，value被onStart中的value覆盖</span><br><span class="line">   &#125;</span><br><span class="line">   @Override</span><br><span class="line">   protected void onStart() &#123;</span><br><span class="line">       super.onStart();</span><br><span class="line">       Log.i(TAG, &quot;onStart: &quot;);</span><br><span class="line">       mLiveData.setValue(&quot;onStart&quot;);//活跃状态，会回调onChanged。并且value会覆盖onCreate、onStop中设置的value</span><br><span class="line">   &#125;</span><br><span class="line">   @Override</span><br><span class="line">   protected void onResume() &#123;</span><br><span class="line">       super.onResume();</span><br><span class="line">       Log.i(TAG, &quot;onResume: &quot;);</span><br><span class="line">       mLiveData.setValue(&quot;onResume&quot;);//活跃状态，回调onChanged</span><br><span class="line">   &#125;</span><br><span class="line">   @Override</span><br><span class="line">   protected void onPause() &#123;</span><br><span class="line">       super.onPause();</span><br><span class="line">       Log.i(TAG, &quot;onPause: &quot;);</span><br><span class="line">       mLiveData.setValue(&quot;onPause&quot;);//活跃状态，回调onChanged</span><br><span class="line">   &#125;</span><br><span class="line">   @Override</span><br><span class="line">   protected void onStop() &#123;</span><br><span class="line">       super.onStop();</span><br><span class="line">       Log.i(TAG, &quot;onStop: &quot;);</span><br><span class="line">       mLiveData.setValue(&quot;onStop&quot;);//非活跃状态，不会回调onChanged。后面变为活跃时，value被onStart中的value覆盖</span><br><span class="line">   &#125;</span><br><span class="line">   @Override</span><br><span class="line">   protected void onDestroy() &#123;</span><br><span class="line">       super.onDestroy();</span><br><span class="line">       Log.i(TAG, &quot;onDestroy: &quot;);</span><br><span class="line">       mLiveData.setValue(&quot;onDestroy&quot;);//非活跃状态，且此时Observer已被移除，不会回调onChanged</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="注意：除了使用-observe-方法添加观察者，也可以使用-observeForever-Observer-方法来注册未关联-LifecycleOwner-的观察者。在这种情况下，观察者会被视为始终处于活跃状态。"><a href="#注意：除了使用-observe-方法添加观察者，也可以使用-observeForever-Observer-方法来注册未关联-LifecycleOwner-的观察者。在这种情况下，观察者会被视为始终处于活跃状态。" class="headerlink" title="注意：除了使用 observe() 方法添加观察者，也可以使用 observeForever(Observer) 方法来注册未关联 LifecycleOwner 的观察者。在这种情况下，观察者会被视为始终处于活跃状态。"></a>注意：除了使用 <code>observe()</code> 方法添加观察者，也可以使用 <code>observeForever(Observer)</code> 方法来注册未关联 <code>LifecycleOwner</code> 的观察者。在这种情况下，观察者会被视为始终处于活跃状态。</h5><h3 id="LiveData-的进阶使用"><a href="#LiveData-的进阶使用" class="headerlink" title="LiveData 的进阶使用"></a>LiveData 的进阶使用</h3><h4 id="1-Transformations-map-，如果想要在-LiveData-对象分发给观察者之前对其中存储的值进行更改，可以使用该方法。"><a href="#1-Transformations-map-，如果想要在-LiveData-对象分发给观察者之前对其中存储的值进行更改，可以使用该方法。" class="headerlink" title="1. Transformations.map()，如果想要在 LiveData 对象分发给观察者之前对其中存储的值进行更改，可以使用该方法。"></a>1. <code>Transformations.map()</code>，如果想要在 <code>LiveData</code> 对象分发给观察者之前对其中存储的值进行更改，可以使用该方法。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  //Integer类型的liveData</span><br><span class="line">  MutableLiveData&lt;Integer&gt; liveData = new MutableLiveData&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  //转换成String类型的transformedLiveData</span><br><span class="line">  LiveData&lt;String&gt; transformedLiveData  = Transformations.map(liveData1, new Function&lt;Integer, String&gt;() &#123;</span><br><span class="line">      @Override</span><br><span class="line">      public String apply(Integer input) &#123;</span><br><span class="line">          String s = input + &quot; + Transformations.map&quot;;</span><br><span class="line">          Log.i(TAG, &quot;apply: &quot; + s);</span><br><span class="line">          return s;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">transformedLiveData .observe(this, new Observer&lt;String&gt;() &#123;</span><br><span class="line">      @Override</span><br><span class="line">      public void onChanged(String s) &#123;</span><br><span class="line">          Log.i(TAG, &quot;onChanged1: &quot;+s);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  liveData.setValue(100);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-Transformations-switchMap-，如果想要手动控制监听其中一个的数据变化，并能根据需要随时切换监听，这时可以使用-Transformations-switchMap-，它和-Transformations-map-使用方式类似，只不过switchMap-必须返回一个-LiveData-对象。如果要返回-必须返回一个LiveData-对象-就用-switchMap-，不需要就用-map-，效果差不多。"><a href="#2-Transformations-switchMap-，如果想要手动控制监听其中一个的数据变化，并能根据需要随时切换监听，这时可以使用-Transformations-switchMap-，它和-Transformations-map-使用方式类似，只不过switchMap-必须返回一个-LiveData-对象。如果要返回-必须返回一个LiveData-对象-就用-switchMap-，不需要就用-map-，效果差不多。" class="headerlink" title="2. Transformations.switchMap() ，如果想要手动控制监听其中一个的数据变化，并能根据需要随时切换监听，这时可以使用 Transformations.switchMap() ，它和 Transformations.map() 使用方式类似，只不过switchMap() 必须返回一个 LiveData 对象。如果要返回 必须返回一个LiveData 对象 就用 switchMap ，不需要就用 map ，效果差不多。"></a>2. <code>Transformations.switchMap()</code> ，如果想要手动控制监听其中一个的数据变化，并能根据需要随时切换监听，这时可以使用 <code>Transformations.switchMap()</code> ，它和 <code>Transformations.map()</code> 使用方式类似，只不过<code>switchMap()</code> 必须返回一个 <code>LiveData</code> 对象。如果要返回 <code>必须返回一个LiveData</code> 对象 就用 <code>switchMap</code> ，不需要就用 <code>map</code> ，效果差不多。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class MainActivity extends AppCompatActivity &#123;</span><br><span class="line">    private static final String TAG = &quot;MainActivity&quot;;</span><br><span class="line">    MutableLiveData&lt;String&gt; mutableLiveData1;</span><br><span class="line">    MutableLiveData&lt;String&gt; mutableLiveData2;</span><br><span class="line">    MutableLiveData&lt;Boolean&gt; liveDataSwitch;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        mutableLiveData1 = new MutableLiveData&lt;&gt;();</span><br><span class="line">        mutableLiveData2 = new MutableLiveData&lt;&gt;();</span><br><span class="line">        liveDataSwitch = new MutableLiveData&lt;Boolean&gt;();//1</span><br><span class="line"></span><br><span class="line">        LiveData transformedLiveData= Transformations.switchMap(liveDataSwitch, new Function&lt;Boolean, LiveData&lt;String&gt;&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public LiveData&lt;String&gt; apply(Boolean input) &#123;</span><br><span class="line">                if (input) &#123;</span><br><span class="line">                    return mutableLiveData1;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    return mutableLiveData2;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        transformedLiveData.observe(this, new Observer&lt;String&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onChanged(@Nullable final String s) &#123;</span><br><span class="line">                Log.d(TAG, &quot;onChanged:&quot; + s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        liveDataSwitch.postValue(false);//2</span><br><span class="line">        mutableLiveData1.postValue(&quot;kotlin&quot;);</span><br><span class="line">        mutableLiveData2.postValue(&quot;java&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="通过-liveDataSwitch-对象控制是监听-mutableLiveData1-的数据还是-mutableLiveData2-的数据。"><a href="#通过-liveDataSwitch-对象控制是监听-mutableLiveData1-的数据还是-mutableLiveData2-的数据。" class="headerlink" title="通过 liveDataSwitch 对象控制是监听 mutableLiveData1 的数据还是 mutableLiveData2 的数据。"></a>通过 <code>liveDataSwitch</code> 对象控制是监听 <code>mutableLiveData1</code> 的数据还是 <code>mutableLiveData2</code> 的数据。</h5><h4 id="3-合并多个-LiveData-数据源，MediatorLiveData-继承自-mutableLiveData-，它可以将多个-LiveData-数据源集合起来，可以达到一个组件监听多个-LiveData-数据变化的目的。"><a href="#3-合并多个-LiveData-数据源，MediatorLiveData-继承自-mutableLiveData-，它可以将多个-LiveData-数据源集合起来，可以达到一个组件监听多个-LiveData-数据变化的目的。" class="headerlink" title="3. 合并多个 LiveData 数据源，MediatorLiveData 继承自 mutableLiveData ，它可以将多个 LiveData 数据源集合起来，可以达到一个组件监听多个 LiveData 数据变化的目的。"></a>3. 合并多个 <code>LiveData</code> 数据源，<code>MediatorLiveData</code> 继承自 <code>mutableLiveData</code> ，它可以将多个 <code>LiveData</code> 数据源集合起来，可以达到一个组件监听多个 <code>LiveData</code> 数据变化的目的。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">val mutableLiveData1 = MutableLiveData&lt;String&gt;()</span><br><span class="line">val mutableLiveData2 = MutableLiveData&lt;String&gt;()</span><br><span class="line">val liveDataMerger = MediatorLiveData&lt;String&gt;()</span><br><span class="line">liveDataMerger.addSource(mutableLiveData1, object : Observer&lt;String&gt; &#123;</span><br><span class="line">    override fun onChanged( o: String) &#123;</span><br><span class="line">        LogUtils.d(TAG, &quot;onChanged1:$o&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">liveDataMerger.addSource(mutableLiveData2, object : Observer&lt;String&gt; &#123;</span><br><span class="line">    override fun onChanged( o: String) &#123;</span><br><span class="line">        LogUtils.d(TAG, &quot;onChanged2:$o&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">liveDataMerger.observe(this, object : Observer&lt;String&gt; &#123;</span><br><span class="line">    override fun onChanged( o: String) &#123;</span><br><span class="line">        // 这里的触发场景，通常是监听的 Livedata源达到某个条件，再更新 liveDataMerger 的值进行回调的</span><br><span class="line">        LogUtils.d(TAG, &quot;onChanged3:$o&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">mutableLiveData1.postValue(&quot;mutableLiveData1文本&quot;)</span><br><span class="line">mutableLiveData2.postValue(&quot;mutableLiveData2文本&quot;)</span><br></pre></td></tr></table></figure>

<h5 id="其他使用场景：比如有一个列表界面，每一个-item-都可以点赞，每个-item-的赞都是一个数据源，我们可以监听点赞的数量，在达到某个条件处理逻辑。"><a href="#其他使用场景：比如有一个列表界面，每一个-item-都可以点赞，每个-item-的赞都是一个数据源，我们可以监听点赞的数量，在达到某个条件处理逻辑。" class="headerlink" title="其他使用场景：比如有一个列表界面，每一个 item 都可以点赞，每个 item 的赞都是一个数据源，我们可以监听点赞的数量，在达到某个条件处理逻辑。"></a>其他使用场景：比如有一个列表界面，每一个 <code>item</code> 都可以点赞，每个 item 的赞都是一个数据源，我们可以监听点赞的数量，在达到某个条件处理逻辑。</h5><h4 id="4-使用全局-Livedata-在多个视图监听状态"><a href="#4-使用全局-Livedata-在多个视图监听状态" class="headerlink" title="4. 使用全局 Livedata 在多个视图监听状态"></a>4. 使用全局 <code>Livedata</code> 在多个视图监听状态</h4><h4 id="使用步骤："><a href="#使用步骤：" class="headerlink" title="使用步骤："></a>使用步骤：</h4><h5 id="1-自定义-LiveData，重写-onActive-、onInactive-方法。"><a href="#1-自定义-LiveData，重写-onActive-、onInactive-方法。" class="headerlink" title="1. 自定义 LiveData，重写 onActive()、onInactive() 方法。"></a>1. 自定义 <code>LiveData</code>，重写 <code>onActive()、onInactive()</code> 方法。</h5><h5 id="2-实现为单例模式，实现多个-Activity、Fragment-之间共享数据。"><a href="#2-实现为单例模式，实现多个-Activity、Fragment-之间共享数据。" class="headerlink" title="2. 实现为单例模式，实现多个 Activity、Fragment 之间共享数据。"></a>2. 实现为单例模式，实现多个 <code>Activity、Fragment</code> 之间共享数据。</h5><h5 id="官方示例如下："><a href="#官方示例如下：" class="headerlink" title="官方示例如下："></a>官方示例如下：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class StockLiveData extends LiveData&lt;BigDecimal&gt; &#123;</span><br><span class="line">        private static StockLiveData sInstance; //单实例</span><br><span class="line">        private StockManager stockManager;</span><br><span class="line"></span><br><span class="line">        private SimplePriceListener listener = new SimplePriceListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onPriceChanged(BigDecimal price) &#123;</span><br><span class="line">                setValue(price);//监听到股价变化 使用setValue(price) 告知所有活跃观察者</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">	//获取单例</span><br><span class="line">        @MainThread</span><br><span class="line">        public static StockLiveData get(String symbol) &#123;</span><br><span class="line">            if (sInstance == null) &#123;</span><br><span class="line">                sInstance = new StockLiveData(symbol);</span><br><span class="line">            &#125;</span><br><span class="line">            return sInstance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private StockLiveData(String symbol) &#123;</span><br><span class="line">            stockManager = new StockManager(symbol);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">     	//活跃的观察者（LifecycleOwner）数量从 0 变为 1 时调用</span><br><span class="line">        @Override</span><br><span class="line">        protected void onActive() &#123;</span><br><span class="line">            stockManager.requestPriceUpdates(listener);//开始观察股价更新</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">     	//活跃的观察者（LifecycleOwner）数量从 1 变为 0 时调用。这不代表没有观察者了，可能是全都不活跃了。可以使用hasObservers()检查是否有观察者。</span><br><span class="line">        @Override</span><br><span class="line">        protected void onInactive() &#123;</span><br><span class="line">            stockManager.removeUpdates(listener);//移除股价更新的观察</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="使用方式："><a href="#使用方式：" class="headerlink" title="使用方式："></a>使用方式：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class MyFragment extends Fragment &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onViewCreated(view, savedInstanceState);</span><br><span class="line">        //获取StockLiveData单实例，添加观察者，更新UI</span><br><span class="line">        StockLiveData.get(symbol).observe(getViewLifecycleOwner(), price -&gt; &#123;</span><br><span class="line">            // Update the UI.</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="其他示例，比如有一个登录验证码倒计时界面，在倒计时，需要在其他的页面也要同步这个倒计时状态，可以这样写："><a href="#其他示例，比如有一个登录验证码倒计时界面，在倒计时，需要在其他的页面也要同步这个倒计时状态，可以这样写：" class="headerlink" title="其他示例，比如有一个登录验证码倒计时界面，在倒计时，需要在其他的页面也要同步这个倒计时状态，可以这样写："></a>其他示例，比如有一个登录验证码倒计时界面，在倒计时，需要在其他的页面也要同步这个倒计时状态，可以这样写：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class GlobalLivedata : LiveData&lt;String&gt;() &#123;</span><br><span class="line">    val coundManager = CountDownManager()</span><br><span class="line">    val listener = object : OnDataChangeListener &#123;</span><br><span class="line">        override fun change(data: String) &#123;</span><br><span class="line">           postValue(data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    override fun onActive() &#123;</span><br><span class="line">        super.onActive()</span><br><span class="line">        coundManager.setListener(listener)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun onInactive() &#123;</span><br><span class="line">        super.onInactive()</span><br><span class="line">        coundManager.removeListener(listener)</span><br><span class="line">    &#125;</span><br><span class="line">    companion object &#123;</span><br><span class="line">        private lateinit var globalData: GlobalLivedata</span><br><span class="line">        fun getInstance(): GlobalLivedata &#123;</span><br><span class="line">            globalData = if (::globalData.isInitialized) globalData else GlobalLivedata()</span><br><span class="line">            return globalData</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 
    </div>
    <footer class="article-footer">
      <!-- data-url="https://liuhangya.github.io/2022/06/06/livedata/"
      data-id="clmfp4rrp0001s8b91s6m7ja8"
      class="article-share-link" -->
      <!-- <a class="article-share-link">
        分享
      </a> -->
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jetpack-android/" rel="tag">jetpack android</a></li></ul>

    </footer>
  </div>

   
<nav class="article-nav">
  
  <a href="/2023/08/29/android/architecture/architecture/" class="article-nav-link">
    <strong class="article-nav-caption">前一篇</strong>
    <div class="article-nav-title">
      
      Android 架构演进分析和代码演示
      
    </div>
  </a>
  
  
</nav>
  
  
<div class="vcomments" id="vcomments"></div>

<script src="https://unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  new Valine({
    el: '#vcomments',
    appId: 'mXq6Jmscj2XizYUdnKDqcjvO-gzGzoHsz',
    appKey: 'YY1txddK6dY4r0OHRNfbbpYN',
    notify: 'false',
    verify: 'true',
    avatar: 'mp',
    pageSize: '10',
    placeholder: '请输入...'
  })
</script>
  
</article>

</section>
    <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
  <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>fanda&#39;s blog &copy; 2023</li>
      
        <li></li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="fanda&#39;s blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">首页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">相册</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/favorites">收藏</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>





<script src="/js/tocbot.min.js"></script>


<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>